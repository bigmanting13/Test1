# ==============================
# SOL Live Process Logger
# Press ENTER to stop.
# ==============================

$WebhookURL = "https://discord.com/api/webhooks/1472618505412280581/NN6uESabI44NgZRf4OiKAAZSY9IFbZqsAELEDAa9BjUDmmHn3qHLxf_VskhLR5TH8x9l"
$UserTag = $env:USERNAME

# batching settings (avoid Discord rate limits)
$ProcessBuffer = New-Object System.Collections.Generic.List[string]
$LastSend = Get-Date
$SendEverySeconds = 5
$SendMaxItems = 8

function Send-DiscordMessage {
    param([string]$Message)
    $body = @{ content = $Message } | ConvertTo-Json
    try {
        Invoke-RestMethod -Uri $WebhookURL -Method Post -Body $body -ContentType "application/json" | Out-Null
    } catch {
        # ignore send errors
    }
}

function Flush-DiscordBatch {
    if ($ProcessBuffer.Count -eq 0) { return }
    $msg = "**$UserTag**`n **Process Activity (new launches)**`n" + ($ProcessBuffer -join "`n")
    Send-DiscordMessage $msg
    $ProcessBuffer.Clear()
    $global:LastSend = Get-Date
}

function Get-SigStatusFast {
    param([string]$Path)
    if (-not $Path -or -not (Test-Path -LiteralPath $Path)) { return "NoPath" }
    try { return (Get-AuthenticodeSignature -FilePath $Path).Status.ToString() }
    catch { return "SigError" }
}

# Start message
Send-DiscordMessage " **$UserTag**`n Monitoring started"

# Register for process start events in THIS session
$srcId = "SOL.ProcStart"
try { Unregister-Event -SourceIdentifier $srcId -ErrorAction SilentlyContinue } catch {}
Register-WmiEvent -Class Win32_ProcessStartTrace -SourceIdentifier $srcId | Out-Null

Write-Host ""
Write-Host "Process monitoring running... Launch something like Notepad to test." -ForegroundColor Green
Write-Host "Press ENTER to stop monitoring." -ForegroundColor Yellow

try {
    while ($true) {
        # stop when user presses Enter
        if ([Console]::KeyAvailable) {
            $k = [Console]::ReadKey($true)
            if ($k.Key -eq "Enter") { break }
        }

        # read any pending events
        $evt = Wait-Event -SourceIdentifier $srcId -Timeout 0.5
        if ($evt) {
            $p = $evt.SourceEventArgs.NewEvent
            $time = Get-Date -Format "HH:mm:ss"
            $procid  = [int]$p.ProcessID
            $name = [string]$p.ProcessName

            # Try to get full path (may fail for protected processes)
            $path = ""
            try {
                $proc = Get-CimInstance Win32_Process -Filter "ProcessId=$procid"
                if ($proc -and $proc.ExecutablePath) { $path = [string]$proc.ExecutablePath }
            } catch {}

            $sig = Get-SigStatusFast -Path $path

            # Reduce noise: skip Microsoft-signed System32 processes
            if ($sig -eq "Valid" -and $path -match "\\Windows\\System32\\") {
                Remove-Event -EventIdentifier $evt.EventIdentifier -ErrorAction SilentlyContinue
                continue
            }

            $entry = "[$time] $name | Sig: $sig | Path: " + ($(if($path){$path}else{"<no path>"}))
            $ProcessBuffer.Add($entry) | Out-Null

            # flush if buffer big or time elapsed
            if ($ProcessBuffer.Count -ge $SendMaxItems -or (Get-Date) -gt $LastSend.AddSeconds($SendEverySeconds)) {
                Flush-DiscordBatch
            }

            Remove-Event -EventIdentifier $evt.EventIdentifier -ErrorAction SilentlyContinue
        }
    }
}
finally {
    # cleanup + final flush
    Flush-DiscordBatch
    try { Unregister-Event -SourceIdentifier $srcId -ErrorAction SilentlyContinue } catch {}
    try { Remove-Event -SourceIdentifier $srcId -ErrorAction SilentlyContinue } catch {}
    Send-DiscordMessage "**$UserTag**`n Monitoring ended"
}

