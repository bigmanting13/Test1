# ==============================
# SOL Live Process Logger
# Press ENTER to stop.
# ==============================

$WebhookURL = "https://discord.com/api/webhooks/1472618505412280581/NN6uESabI44NgZRf4OiKAAZSY9IFbZqsAELEDAa9BjUDmmHn3qHLxf_VskhLR5TH8x9l"
$UserTag = $env:USERNAME

# batching
$ProcessBuffer = New-Object System.Collections.Generic.List[string]
$LastSend = Get-Date
$SendEverySeconds = 5
$SendMaxItems = 8

# de-dupe (same Name+Path within this window)
$DedupWindowSeconds = 20
$LastSeen = @{}  # key -> DateTime

# optional: ignore noisy apps unless unsigned/unknown
$NoisyNames = @(
  "msedge.exe","chrome.exe","opera.exe","Discord.exe","steam.exe"
)

function Send-DiscordMessage {
    param([string]$Message)
    $body = @{ content = $Message } | ConvertTo-Json
    try { Invoke-RestMethod -Uri $WebhookURL -Method Post -Body $body -ContentType "application/json" | Out-Null } catch {}
}

function Flush-DiscordBatch {
    if ($ProcessBuffer.Count -eq 0) { return }
    $msg = "üë§ **$UserTag**`n‚ö†Ô∏è **Process starts (new instances)**`n" + ($ProcessBuffer -join "`n")
    Send-DiscordMessage $msg
    $ProcessBuffer.Clear()
    $global:LastSend = Get-Date
}

function Get-SigStatusFast {
    param([string]$Path)
    if (-not $Path -or -not (Test-Path -LiteralPath $Path)) { return "NoPath" }
    try { return (Get-AuthenticodeSignature -FilePath $Path).Status.ToString() } catch { return "SigError" }
}

Send-DiscordMessage "üë§ **$UserTag**`nüü¢ Monitoring started"

$srcId = "SOL.ProcStart"
try { Unregister-Event -SourceIdentifier $srcId -ErrorAction SilentlyContinue } catch {}
Register-WmiEvent -Class Win32_ProcessStartTrace -SourceIdentifier $srcId | Out-Null

Write-Host ""
Write-Host "Monitoring process starts... (open Notepad to test)" -ForegroundColor Green
Write-Host "Press ENTER to stop." -ForegroundColor Yellow

try {
    while ($true) {
        if ([Console]::KeyAvailable) {
            $k = [Console]::ReadKey($true)
            if ($k.Key -eq "Enter") { break }
        }

        $evt = Wait-Event -SourceIdentifier $srcId -Timeout 0.5
        if (-not $evt) {
            if ((Get-Date) -gt $LastSend.AddSeconds($SendEverySeconds)) { Flush-DiscordBatch }
            continue
        }

        $p = $evt.SourceEventArgs.NewEvent
        $time = Get-Date -Format "HH:mm:ss"
        $procId  = [int]$p.ProcessID
        $pprocId = [int]$p.ParentProcessID
        $name = [string]$p.ProcessName

        # Best-effort path lookup (can fail for protected processes)
        $path = ""
        try {
            $proc = Get-CimInstance Win32_Process -Filter "ProcessId=$procId"
            if ($proc -and $proc.ExecutablePath) { $path = [string]$proc.ExecutablePath }
        } catch {}

        $sig = Get-SigStatusFast -Path $path

        # noise reduction: skip Microsoft-valid System32
        if ($sig -eq "Valid" -and $path -match "\\Windows\\System32\\") {
            Remove-Event -EventIdentifier $evt.EventIdentifier -ErrorAction SilentlyContinue
            continue
        }

        # optional: skip noisy apps unless unsigned/unknown
        if (($NoisyNames -contains $name) -and ($sig -eq "Valid")) {
            Remove-Event -EventIdentifier $evt.EventIdentifier -ErrorAction SilentlyContinue
            continue
        }

        # de-dupe bursts
        $key = "$name|$path|$sig"
        $now = Get-Date
        if ($LastSeen.ContainsKey($key)) {
            $delta = ($now - $LastSeen[$key]).TotalSeconds
            if ($delta -lt $DedupWindowSeconds) {
                Remove-Event -EventIdentifier $evt.EventIdentifier -ErrorAction SilentlyContinue
                continue
            }
        }
        $LastSeen[$key] = $now

        $pstr = if ($path) { $path } else { "<no path>" }
        $entry = "[$time] $name (PID:$procId PPID:$pprocId) | Sig:$sig | $pstr"
        $ProcessBuffer.Add($entry) | Out-Null

        if ($ProcessBuffer.Count -ge $SendMaxItems) { Flush-DiscordBatch }

        Remove-Event -EventIdentifier $evt.EventIdentifier -ErrorAction SilentlyContinue
    }
}
finally {
    Flush-DiscordBatch
    try { Unregister-Event -SourceIdentifier $srcId -ErrorAction SilentlyContinue } catch {}
    try { Remove-Event -SourceIdentifier $srcId -ErrorAction SilentlyContinue } catch {}
    Send-DiscordMessage "üë§ **$UserTag**`nüî¥ Monitoring ended"
}
